revoke delete on table "public"."trackpay_activities" from "anon";

revoke insert on table "public"."trackpay_activities" from "anon";

revoke references on table "public"."trackpay_activities" from "anon";

revoke select on table "public"."trackpay_activities" from "anon";

revoke trigger on table "public"."trackpay_activities" from "anon";

revoke truncate on table "public"."trackpay_activities" from "anon";

revoke update on table "public"."trackpay_activities" from "anon";

revoke delete on table "public"."trackpay_activities" from "authenticated";

revoke insert on table "public"."trackpay_activities" from "authenticated";

revoke references on table "public"."trackpay_activities" from "authenticated";

revoke select on table "public"."trackpay_activities" from "authenticated";

revoke trigger on table "public"."trackpay_activities" from "authenticated";

revoke truncate on table "public"."trackpay_activities" from "authenticated";

revoke update on table "public"."trackpay_activities" from "authenticated";

revoke delete on table "public"."trackpay_activities" from "service_role";

revoke insert on table "public"."trackpay_activities" from "service_role";

revoke references on table "public"."trackpay_activities" from "service_role";

revoke select on table "public"."trackpay_activities" from "service_role";

revoke trigger on table "public"."trackpay_activities" from "service_role";

revoke truncate on table "public"."trackpay_activities" from "service_role";

revoke update on table "public"."trackpay_activities" from "service_role";

revoke delete on table "public"."trackpay_invites" from "anon";

revoke insert on table "public"."trackpay_invites" from "anon";

revoke references on table "public"."trackpay_invites" from "anon";

revoke select on table "public"."trackpay_invites" from "anon";

revoke trigger on table "public"."trackpay_invites" from "anon";

revoke truncate on table "public"."trackpay_invites" from "anon";

revoke update on table "public"."trackpay_invites" from "anon";

revoke delete on table "public"."trackpay_invites" from "authenticated";

revoke insert on table "public"."trackpay_invites" from "authenticated";

revoke references on table "public"."trackpay_invites" from "authenticated";

revoke select on table "public"."trackpay_invites" from "authenticated";

revoke trigger on table "public"."trackpay_invites" from "authenticated";

revoke truncate on table "public"."trackpay_invites" from "authenticated";

revoke update on table "public"."trackpay_invites" from "authenticated";

revoke delete on table "public"."trackpay_invites" from "service_role";

revoke insert on table "public"."trackpay_invites" from "service_role";

revoke references on table "public"."trackpay_invites" from "service_role";

revoke select on table "public"."trackpay_invites" from "service_role";

revoke trigger on table "public"."trackpay_invites" from "service_role";

revoke truncate on table "public"."trackpay_invites" from "service_role";

revoke update on table "public"."trackpay_invites" from "service_role";

revoke delete on table "public"."trackpay_payments" from "anon";

revoke insert on table "public"."trackpay_payments" from "anon";

revoke references on table "public"."trackpay_payments" from "anon";

revoke select on table "public"."trackpay_payments" from "anon";

revoke trigger on table "public"."trackpay_payments" from "anon";

revoke truncate on table "public"."trackpay_payments" from "anon";

revoke update on table "public"."trackpay_payments" from "anon";

revoke delete on table "public"."trackpay_payments" from "authenticated";

revoke insert on table "public"."trackpay_payments" from "authenticated";

revoke references on table "public"."trackpay_payments" from "authenticated";

revoke select on table "public"."trackpay_payments" from "authenticated";

revoke trigger on table "public"."trackpay_payments" from "authenticated";

revoke truncate on table "public"."trackpay_payments" from "authenticated";

revoke update on table "public"."trackpay_payments" from "authenticated";

revoke delete on table "public"."trackpay_payments" from "service_role";

revoke insert on table "public"."trackpay_payments" from "service_role";

revoke references on table "public"."trackpay_payments" from "service_role";

revoke select on table "public"."trackpay_payments" from "service_role";

revoke trigger on table "public"."trackpay_payments" from "service_role";

revoke truncate on table "public"."trackpay_payments" from "service_role";

revoke update on table "public"."trackpay_payments" from "service_role";

revoke delete on table "public"."trackpay_relationship_audit" from "anon";

revoke insert on table "public"."trackpay_relationship_audit" from "anon";

revoke references on table "public"."trackpay_relationship_audit" from "anon";

revoke select on table "public"."trackpay_relationship_audit" from "anon";

revoke trigger on table "public"."trackpay_relationship_audit" from "anon";

revoke truncate on table "public"."trackpay_relationship_audit" from "anon";

revoke update on table "public"."trackpay_relationship_audit" from "anon";

revoke delete on table "public"."trackpay_relationship_audit" from "authenticated";

revoke insert on table "public"."trackpay_relationship_audit" from "authenticated";

revoke references on table "public"."trackpay_relationship_audit" from "authenticated";

revoke select on table "public"."trackpay_relationship_audit" from "authenticated";

revoke trigger on table "public"."trackpay_relationship_audit" from "authenticated";

revoke truncate on table "public"."trackpay_relationship_audit" from "authenticated";

revoke update on table "public"."trackpay_relationship_audit" from "authenticated";

revoke delete on table "public"."trackpay_relationship_audit" from "service_role";

revoke insert on table "public"."trackpay_relationship_audit" from "service_role";

revoke references on table "public"."trackpay_relationship_audit" from "service_role";

revoke select on table "public"."trackpay_relationship_audit" from "service_role";

revoke trigger on table "public"."trackpay_relationship_audit" from "service_role";

revoke truncate on table "public"."trackpay_relationship_audit" from "service_role";

revoke update on table "public"."trackpay_relationship_audit" from "service_role";

revoke delete on table "public"."trackpay_relationships" from "anon";

revoke insert on table "public"."trackpay_relationships" from "anon";

revoke references on table "public"."trackpay_relationships" from "anon";

revoke select on table "public"."trackpay_relationships" from "anon";

revoke trigger on table "public"."trackpay_relationships" from "anon";

revoke truncate on table "public"."trackpay_relationships" from "anon";

revoke update on table "public"."trackpay_relationships" from "anon";

revoke insert on table "public"."trackpay_relationships" from "authenticated";

revoke references on table "public"."trackpay_relationships" from "authenticated";

revoke select on table "public"."trackpay_relationships" from "authenticated";

revoke trigger on table "public"."trackpay_relationships" from "authenticated";

revoke truncate on table "public"."trackpay_relationships" from "authenticated";

revoke update on table "public"."trackpay_relationships" from "authenticated";

revoke delete on table "public"."trackpay_relationships" from "service_role";

revoke insert on table "public"."trackpay_relationships" from "service_role";

revoke references on table "public"."trackpay_relationships" from "service_role";

revoke select on table "public"."trackpay_relationships" from "service_role";

revoke trigger on table "public"."trackpay_relationships" from "service_role";

revoke truncate on table "public"."trackpay_relationships" from "service_role";

revoke update on table "public"."trackpay_relationships" from "service_role";

revoke delete on table "public"."trackpay_requests" from "anon";

revoke insert on table "public"."trackpay_requests" from "anon";

revoke references on table "public"."trackpay_requests" from "anon";

revoke select on table "public"."trackpay_requests" from "anon";

revoke trigger on table "public"."trackpay_requests" from "anon";

revoke truncate on table "public"."trackpay_requests" from "anon";

revoke update on table "public"."trackpay_requests" from "anon";

revoke delete on table "public"."trackpay_requests" from "authenticated";

revoke insert on table "public"."trackpay_requests" from "authenticated";

revoke references on table "public"."trackpay_requests" from "authenticated";

revoke select on table "public"."trackpay_requests" from "authenticated";

revoke trigger on table "public"."trackpay_requests" from "authenticated";

revoke truncate on table "public"."trackpay_requests" from "authenticated";

revoke update on table "public"."trackpay_requests" from "authenticated";

revoke delete on table "public"."trackpay_requests" from "service_role";

revoke insert on table "public"."trackpay_requests" from "service_role";

revoke references on table "public"."trackpay_requests" from "service_role";

revoke select on table "public"."trackpay_requests" from "service_role";

revoke trigger on table "public"."trackpay_requests" from "service_role";

revoke truncate on table "public"."trackpay_requests" from "service_role";

revoke update on table "public"."trackpay_requests" from "service_role";

revoke delete on table "public"."trackpay_sessions" from "anon";

revoke insert on table "public"."trackpay_sessions" from "anon";

revoke references on table "public"."trackpay_sessions" from "anon";

revoke select on table "public"."trackpay_sessions" from "anon";

revoke trigger on table "public"."trackpay_sessions" from "anon";

revoke truncate on table "public"."trackpay_sessions" from "anon";

revoke update on table "public"."trackpay_sessions" from "anon";

revoke delete on table "public"."trackpay_sessions" from "authenticated";

revoke insert on table "public"."trackpay_sessions" from "authenticated";

revoke references on table "public"."trackpay_sessions" from "authenticated";

revoke select on table "public"."trackpay_sessions" from "authenticated";

revoke trigger on table "public"."trackpay_sessions" from "authenticated";

revoke truncate on table "public"."trackpay_sessions" from "authenticated";

revoke update on table "public"."trackpay_sessions" from "authenticated";

revoke delete on table "public"."trackpay_sessions" from "service_role";

revoke insert on table "public"."trackpay_sessions" from "service_role";

revoke references on table "public"."trackpay_sessions" from "service_role";

revoke select on table "public"."trackpay_sessions" from "service_role";

revoke trigger on table "public"."trackpay_sessions" from "service_role";

revoke truncate on table "public"."trackpay_sessions" from "service_role";

revoke update on table "public"."trackpay_sessions" from "service_role";

revoke delete on table "public"."trackpay_users" from "anon";

revoke insert on table "public"."trackpay_users" from "anon";

revoke references on table "public"."trackpay_users" from "anon";

revoke select on table "public"."trackpay_users" from "anon";

revoke trigger on table "public"."trackpay_users" from "anon";

revoke truncate on table "public"."trackpay_users" from "anon";

revoke update on table "public"."trackpay_users" from "anon";

revoke delete on table "public"."trackpay_users" from "authenticated";

revoke insert on table "public"."trackpay_users" from "authenticated";

revoke references on table "public"."trackpay_users" from "authenticated";

revoke select on table "public"."trackpay_users" from "authenticated";

revoke trigger on table "public"."trackpay_users" from "authenticated";

revoke truncate on table "public"."trackpay_users" from "authenticated";

revoke update on table "public"."trackpay_users" from "authenticated";

revoke delete on table "public"."trackpay_users" from "service_role";

revoke insert on table "public"."trackpay_users" from "service_role";

revoke references on table "public"."trackpay_users" from "service_role";

revoke select on table "public"."trackpay_users" from "service_role";

revoke trigger on table "public"."trackpay_users" from "service_role";

revoke truncate on table "public"."trackpay_users" from "service_role";

revoke update on table "public"."trackpay_users" from "service_role";

set check_function_bodies = off;

CREATE OR REPLACE FUNCTION public.current_trackpay_user_id()
 RETURNS uuid
 LANGUAGE sql
 STABLE SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
  SELECT id
  FROM public.trackpay_users
  WHERE auth_user_id = auth.uid()
  LIMIT 1
$function$
;

CREATE OR REPLACE FUNCTION public.delete_client_relationship_safely(p_client_id uuid)
 RETURNS boolean
 LANGUAGE plpgsql
 SECURITY DEFINER
 SET search_path TO 'public'
AS $function$
DECLARE
  v_auth_id    uuid := auth.uid();
  v_provider   uuid;
  v_deleted    boolean := false;
  v_reason     text := null;
BEGIN
  -- Check authentication
  IF v_auth_id IS NULL THEN
    RAISE EXCEPTION 'Not authenticated.';
  END IF;

  -- Look up trackpay_users.id from auth_user_id
  SELECT id INTO v_provider
  FROM public.trackpay_users
  WHERE auth_user_id = v_auth_id
    AND role = 'provider'
  LIMIT 1;

  IF v_provider IS NULL THEN
    RAISE EXCEPTION 'Provider account not found.';
  END IF;

  -- Attempt atomic delete with blocker checks
  WITH del AS (
    DELETE FROM public.trackpay_relationships r
    WHERE r.provider_id = v_provider
      AND r.client_id = p_client_id
      AND NOT EXISTS (
        SELECT 1 FROM public.trackpay_sessions s
        WHERE s.provider_id = v_provider
          AND s.client_id = p_client_id
          AND s.status IN ('active', 'unpaid', 'requested')
      )
      AND NOT EXISTS (
        SELECT 1 FROM public.trackpay_requests pr
        WHERE pr.provider_id = v_provider
          AND pr.client_id = p_client_id
          AND pr.status IN ('pending', 'sent', 'requested')
      )
    RETURNING 1
  )
  SELECT true INTO v_deleted FROM del;

  -- If successfully deleted, log it
  IF v_deleted THEN
    INSERT INTO public.trackpay_relationship_audit (provider_id, client_id, action, created_at)
    VALUES (v_provider, p_client_id, 'delete_success', now());
    RETURN true;
  END IF;

  -- Check why delete failed (for audit logging)
  IF EXISTS (
    SELECT 1 FROM public.trackpay_sessions s
    WHERE s.provider_id = v_provider
      AND s.client_id = p_client_id
      AND s.status IN ('active', 'unpaid', 'requested')
  ) THEN
    v_reason := 'active_or_unpaid_sessions';
    INSERT INTO public.trackpay_relationship_audit (provider_id, client_id, action, reason, created_at)
    VALUES (v_provider, p_client_id, 'delete_blocked', v_reason, now());
    RAISE EXCEPTION 'Cannot delete. Active or unpaid sessions exist.';
  END IF;

  IF EXISTS (
    SELECT 1 FROM public.trackpay_requests pr
    WHERE pr.provider_id = v_provider
      AND pr.client_id = p_client_id
      AND pr.status IN ('pending', 'sent', 'requested')
  ) THEN
    v_reason := 'outstanding_payment_requests';
    INSERT INTO public.trackpay_relationship_audit (provider_id, client_id, action, reason, created_at)
    VALUES (v_provider, p_client_id, 'delete_blocked', v_reason, now());
    RAISE EXCEPTION 'Cannot delete. Outstanding payment requests exist.';
  END IF;

  -- Relationship doesn't exist (already deleted)
  INSERT INTO public.trackpay_relationship_audit (provider_id, client_id, action, created_at)
  VALUES (v_provider, p_client_id, 'delete_already_gone', now());
  RETURN false;
END $function$
;


